
========================================================================
OpenCCVoice Guidance Controller
取扱説明書 / コマンドリファレンス
========================================================================
バージョン: v1.73-Unified-Safe
最終更新日: 2026/01/22
対象ハード: Arduino Nano (ATmega328P / 5V)
通信設定  : 115200 bps / 8N1 / 改行なし(またはLF)
========================================================================

■ 概要
本機は TM-8250 無線機のID送出を自動制御するコントローラです。
PCとUSB接続し、シリアルモニタから以下のコマンドで設定を変更できます。
変更した設定は即座に内部メモリ(EEPROM)に保存され、電源を切っても保持されます。

【本バージョンの特徴】
・v1.69g のハードウェア配線（DFPlayer: RX=10 / TX=11）のまま動作する互換版です。
・既定の最大受信許容時間は 3.9秒（b3900）です（汎用プリセットに基づく）。
・安全機能（フェイルセーフ）として、音声モジュールが応答しない場合に
  8秒で強制的に送信を停止する機能を搭載しています。
・AUTO判定（m2）により、観測期間（w分）後に D6/A0 のいずれかへ自動固定し、
  EEPROMに保存します（以後、再起動後も固定が維持されます）。

------------------------------------------------------------------------
1. クイック・コマンド一覧
------------------------------------------------------------------------
[コマンド]  [パラメータ]    [既定値]   [機能説明]

 m          0 / 1 / 2         0       動作モード切替
                                      (0:D6固定 / 1:A0固定 / 2:AUTO)
 b          500〜            3900     最大受信時間 (ms)
                                      ※これを超えると長会話とみなす
 n          100〜             500     最小受信時間 (ms)
                                      ※これ未満はノイズとして無視
 i          0〜               200     直前アイドル最小時間 (ms)
 s          0 / 1             1       抑止機能 ON/OFF (長会話・連打対策)
 t          0 / 1             1       送信後無視 ON/OFF (s1時のみ有効)
 r          0〜             3000      送信終了後の受信無視時間 (ms)
 p          0〜              30       周期ID送出間隔 (分) ※0で停止
 w          1〜              30       AUTOモードの判定期間 (分)
 L          0〜1023          300      A0アナログ検知 感度下限
 G          0〜1023          700      A0アナログ検知 感度上限
 a          0〜              800      A0アナログ検知 保持時間 (ms)

 q          なし              -       現在の設定値を一覧表示
 H          なし              -       汎用プリセット適用（s0 / t0 / b3900）
 x          なし              -       システム停止 (保守用・PTT禁止)
 r          なし              -       「x」で停止した処理を再開する
 h          なし              -       コマンド一覧（ヘルプ）を表示
 0〜3       なし              -       ログレベル切替（0:NONE/1:ERR/2:INF/3:DBG）

 F          なし              -       すべての設定を初期値へ戻す
                                      (EEPROM初期化 + applyDefaults の実行)

------------------------------------------------------------------------
2. コマンド詳細解説
------------------------------------------------------------------------

【m：モード設定】
  m0 : デジタル信号(D6)を使用します。[推奨]
  m1 : アナログ音声(A0)を使用します。
  m2 : 自動判定(AUTO)を開始します。
        設定した「w(分)」の間データを測定し、優位な方(D6/A0)に自動で固定・保存します。
        （AUTO観測中は、D6/A0いずれの信号でもIDが出ます）

【b：最大受信時間（カーチャンク許容時間）】
  相手の送信がこの時間(ミリ秒)を超えた場合、「通話」とみなしてID送出を行いません。
  また、長会話直後はID送出を一定時間禁止します（長文抑止）。
  （例）b3900 → 3.9秒までの送信には反応し、それ以上は無視する

【n / i：最小受信時間・直前アイドル】
  n : 受信継続がこの値未満の場合はノイズ等として無視します。
  i : 受信直前のアイドルがこの値未満の場合、短発判定を無効化します。
      （誤トリガの低減に有効）

【s / t / r：抑止ガード】
  IDの乱発を防ぐ機能です。通常は「s1」「t1」で使用してください。
  ・s1 : 長会話の後や、短い連打(バースト)があった時にIDを止めます。
         （短発は10秒窓/2回閾値、長会話は b の超過を検出）
  ・t1 : 自分がIDを出した直後の「r(ミリ秒)」間、受信を無視します。
         無線機の回り込み・誤認を避けるのに有効です。
  ・r  : 送信後無視の継続時間(ms)。例：r5000

【p：周期ID（002/003交互）】
  p##（分）で周期IDをスケジュールします。0で停止します。
  起動時刻からの絶対時刻基準で等間隔に送出します。

【w：AUTO判定の観測期間（分）】
  観測期間満了で D6/A0 の発生数を比較し、優位側へ固定・保存します。
  固定時は D13 LED が約3秒間点滅して通知します。

【L / G / a：A0アナログ検知パラメータ】
  L : LOW閾値、G : HIGH閾値、a : 検出保持(ms)
  ヒステリシス＋保持でアナログ音声のBUSYを安定判定します。

【q：要約表示】
  現在の主要パラメータ（モード、各閾値、周期、抑止状態 等）を一覧表示します。

【H：汎用プリセット】
  よくある構成向けの簡易プリセットを適用します。
  ・抑止機能(s) = OFF
  ・送信後無視(t) = OFF
  ・最大受信時間(b) = 3900 (3.9秒)

【x / r：停止と再開】
  x : 一切の動作(PTT/LED/判定)を停止します（Safe Stop）。
  r : 停止状態を解除し、通常動作へ復帰します。
      ※「r」は停止中のみ有効です（数値パラメータの r#### とは用途が異なります）。

【F：初期値へリセット】
  F : すべての設定を工場出荷時(初期設定)に戻します。
      ・モードは D6固定 (m0) になります。
      ・最大受信時間は 3900ms (b3900) になります。
      ・EEPROMの内容もリセットされます。
      設定がおかしくなった場合はまずこのコマンドを実行してください。

【h / 0〜3：ヘルプ・ログレベル】
  h : コマンド一覧を表示します。
  0〜3 : ログレベルを切替えます（0:NONE / 1:ERR / 2:INF / 3:DBG）。

------------------------------------------------------------------------
3. LED表示の意味
------------------------------------------------------------------------
 [D4]  (D6 LED)  : 点灯 = D6信号を受信中
 [D12] (A0 LED)  : 点灯 = A0音声を検知中
                    ※AUTO判定中は、D4/D12が交互に点滅します。
                    ※未使用側(m0時のA0など)は待機中ゆっくり点滅します。

 [D13] (抑止/AUTO LED)
        ・点灯   = 抑止中（長会話直後/短発連打中/送信後抑止中のいずれか）
        ・点滅   = バースト検知ウィンドウ動作中（短時間連打を検知）
        ・高速点滅 = AUTOモードで設定が確定した合図（約3秒間）

 [D2]  (DFP BUSYミラー)
        ・再生中 = HIGH（反転出力）
        ・停止中 = LOW

------------------------------------------------------------------------
4. 安全機能（フェイルセーフ）について
------------------------------------------------------------------------
本機は、DFPlayer（音声モジュール）の故障やSDカードの接触不良により
「再生中信号」が返ってこない場合でも、送信(PTT)がオンのまま固定される
ことを防ぐため、以下の安全機能が働きます。

・強制タイムアウト: 8秒
  PTT開始から8秒経過しても再生が完了しない場合、強制的にPTTをOFFにします。
  これにより、無変調電波が出続ける事故を防止します。

------------------------------------------------------------------------
5. トラブルシューティング
------------------------------------------------------------------------
・IDが出ない
  → 「x」コマンドで停止していませんか？ r で再開できます。
  → 相手の送信が長すぎませんか？ b の値を確認してください（例: 3.9秒超は無視）。
  → D13が点灯していませんか？抑止機能が働いています。

・IDが出続ける / 止まらない
  → 「t1」にして「r」の時間を延ばしてください(例: r5000)。
  → ノイズを拾っている可能性があります。「n」や「i」の値を上げてください。

・送信(PTT)が一瞬入るが、すぐ切れる（音声が出ない）
  → SDカードのデータ構成を確認してください（/mp3/0001.mp3 等、モジュール仕様準拠）。
  → 配線（D10=Arduino RX / D11=Arduino TX）が正しいか確認してください。

・設定がおかしくなった / 元に戻したい
  → 「F」で初期設定に戻せます（EEPROMの内容も初期化されます）。

------------------------------------------------------------------------
6. 配線メモ（抜粋 / v1.69g 準拠）
------------------------------------------------------------------------
・DFPlayer TX → Arduino D10（Arduino側 RX）
・DFPlayer RX ← Arduino D11（Arduino側 TX）
・DFPlayer BUSY（多くの個体で LOW=再生中）→ D7
・D7 BUSYミラー（反転出力）→ D2（再生中=HIGH / 停止中=LOW）
・TM BUSY → D6（極性は回路に依存。必要に応じてコード側で切替）
・PTT → D5（HIGH=送信）
・LED → D4(D6受信表示), D12(A0表示), D13(抑止/AUTO通知)
・テストSW → D3（INPUT_PULLUP）
========================================================================
