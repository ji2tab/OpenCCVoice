# OpenCCVoice
DMRデジピータ用の音声応答装置 OpenCCVoice の回路図、基板データ、Arduinoスケッチを公開するプロジェクトです。

========================================================================
OpemCCVoice ID Guidance Controller
取扱説明書 / コマンドリファレンス
========================================================================
バージョン: 1.72-final-EEPROM+F (Factory Reset対応)
最終更新日: 2026/01/20
対象ハード: Arduino Nano (ATmega328P / 5V)
通信設定  : 115200 bps / 8N1 / 改行なし(またはLF)
========================================================================

■ 概要
本機は TM-8250 無線機のID送出を自動制御するコントローラです。
PCとUSB接続し、シリアルモニタから以下のコマンドで設定を変更できます。
変更した設定は即座に内部メモリ(EEPROM)に保存され、電源を切っても保持されます。

------------------------------------------------------------------------
1. クイック・コマンド一覧
------------------------------------------------------------------------
[コマンド]  [パラメータ]    [既定値]   [機能説明]

 m          0 / 1 / 2         0       動作モード切替
                                      (0:D6固定 / 1:A0固定 / 2:AUTO)
 b          500〜           1500      最大受信時間 (ms)
                                      ※これを超えると長会話とみなす
 n          100〜            500      最小受信時間 (ms)
                                      ※これ未満はノイズとして無視
 s          0 / 1             1       抑止機能 ON/OFF (長会話・連打対策)
 t          0 / 1             1       送信後無視 ON/OFF (s1時のみ有効)
 r          0〜             3000      送信終了後の受信無視時間 (ms)
 p          0〜              30       周期ID送出間隔 (分) ※0で停止
 w          1〜              30       AUTOモードの判定期間 (分)
 L          0〜1023          300      A0アナログ検知 感度下限
 G          0〜1023          700      A0アナログ検知 感度上限
 a          0〜              800      A0アナログ検知 保持時間 (ms)

 q          なし              -       現在の設定値を一覧表示
 H          なし              -       H1現場用プリセット
 x          なし              -       システム停止 (保守用・PTT禁止)
 r          なし              -       「x」で停止した処理を再開する

 F          なし              -       ★新規★ すべての設定を初期値へ戻す
                                      (EEPROM初期化 + applyDefaults の実行)
------------------------------------------------------------------------
2. コマンド詳細解説
------------------------------------------------------------------------

【m：モード設定】
  m0 : デジタル信号(D6)を使用します。[推奨]
  m1 : アナログ音声(A0)を使用します。
  m2 : 自動判定(AUTO)を開始します。
       設定した「w(分)」の間データを測定し、適切な方に自動で書き換えます。
       (判定中はD6/A0両方の信号でIDが出ます)

【b：最大受信時間】
  相手の送信がこの時間(ミリ秒)を超えた場合、「通話」とみなしてID送出を
  行いません。また、長会話直後のID送出を一定時間禁止します。
  (例) b3000 → 3秒以上の受信にはIDを出さない

【s / t / r：抑止ガード】
  IDの乱発を防ぐ機能です。通常は「s1」「t1」で使用してください。
  ・s1 : 長会話の後や、短い連打(バースト)があった時にIDを止めます。
  ・t1 : 自分がIDを出した直後の「r(ミリ秒)」間、受信を無視します。
         無線機の回り込みで誤作動する場合に有効です。

【H：H1プリセット】
  長いカーチャンク(2〜4秒)がある現場や、とにかくIDを出したい場合の
  緊急用設定です。送信するだけで以下の設定が一括適用されます。
  ・抑止機能(s) = OFF
  ・送信後無視(t) = OFF
  ・最大受信時間(b) = 3900 (3.9秒)

【x / r：停止と再開】
  x : 一切の動作(PTT/LED/判定)を停止します（Safe Stop）。
  r : 停止状態を解除し、通常動作へ復帰します。

【F：初期値へリセット】 ★追加
  F : すべての設定を工場出荷時(初期設定)に戻します。
      ・applyDefaults() を実行し各種パラメータを初期値へ
      ・saveSettings() により EEPROM へ即時保存
      ※「電源を切っても初期状態のまま」動作します

------------------------------------------------------------------------
3. LED表示の意味
------------------------------------------------------------------------
 [D4]  (D6 LED)  : 点灯 = D6信号を受信中
 [D12] (A0 LED)  : 点灯 = A0音声を検知中
                   ※AUTO判定中は、D4/D12が交互に点滅します。

 [D13] (抑止LED) : 点灯 = 抑止中 (長会話直後など / ID禁止)
                   点滅 = バースト検知中 (短時間連打を検知)
                   高速点滅 = AUTOモードで設定が確定した合図(3秒間)

------------------------------------------------------------------------
4. トラブルシューティング
------------------------------------------------------------------------
・IDが出ない
  → 「x」コマンドで停止していませんか？ r で再開できます。
  → 「b」の値が短すぎませんか？長いカーチャンクには「b3000」等を推奨。
  → D13が点灯していませんか？抑止機能が働いています。

・IDが出続ける / 止まらない
  → 「t1」にして「r」の時間を延ばしてください(例: r5000)。
  → ノイズを拾っている可能性があります。「n」の値を上げてください。

・設定がおかしくなった / 元に戻したい
  → 「F」で初期設定に戻せます（EEPROMの内容も初期化されます）。

========================================================================
