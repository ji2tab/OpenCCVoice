# CHANGELOG.md - OpenCCVoice ID Guidance Controller

本プロジェクトは、Arduino Nano (ATmega328P, 5V) 上で動作する、DMR無線機の ID送出支援コントローラです。

記法: Keep a Changelog 準拠  
日付: JST（日本標準時）

--------------------------------------------------------------------

## v1.73c — Unified/Safe + Versioned EEPROM (2026-01-26)
### Added
- **EEPROM レイアウトバージョン管理（config.ver）を導入**  
  - EEPROM の “バージョン不一致” を自動検出  
  - 初期化または移行（マイグレーション）を自動実行  
- **初回読み込み時の自動補完ロジックを追加**  
  - 古い EEPROM の新規項目（tmBusyActiveHigh / dfpTimeoutMs）が未定義でも  
    安全な既定値で補完して動作  
- 要約（q）に **EEPROM_VER=3** を表示  
  → 現在ロードされているレイアウト版を即確認可能

### Changed
- EEPROM 読込時の挙動を強化：  
  - config.magic 不一致 → 完全初期化  
  - config.ver 不一致 → 移行（新規項目の既定補完）  
  - 不正値（0xFF等）は安全な値に強制補正（HIGH=busy / timeout=20000等）

### Notes
- 今後のバージョンアップで構造体に項目を追加しても、  
  **互換性を壊さず自動で安全に移行**できる仕組みが完成。  
- v1.73a/b からの移行でも、既存設定（b/n/p/w/s/t 等）は引き継がれる。

--------------------------------------------------------------------

## v1.73b — Unified/Safe + TM Busy Polarity Cmd (2026-01-22)

### Added
- g#### コマンドを追加（g0/g1）  
  - g0 = TM BUSY が **LOW=受信（アクティブLOW）**  
  - g1 = TM BUSY が **HIGH=受信（アクティブHIGH）**  
- TM BUSY 極性（g0/g1）を **EEPROM保存**  
  再起動後も極性設定を維持  
- 要約（q）に **TM_BUSY_POL=LOW/HIGH** を表示

### Changed
- readTmD6() が g0/g1 設定を完全反映  
- AUTOモード中の D6 統計処理も g0/g1 を反映  
- 古いEEPROMで tmBusyActiveHigh が不正値の時 HIGH=busy に補正

### Notes
- BUSY 出力が  
  **受信でLOWの無線機** / **受信でHIGHの無線機**  
  のどちらにも配線変更なしで対応可能に。

--------------------------------------------------------------------

## v1.73a — Unified/Safe + DFP Timeout Cmd (2026-01-22)

### Added
- d#### コマンドで DFPlayer フェイルセーフ（ms）を可変化。d0 で無効化。
- 要約 q に DFP_TIMEOUT(ms) を表示。

### Changed
- 既定タイムアウトを **20000ms（20秒）** に変更。

### Notes
- d0 でも即切断しないよう PLAYING 内判定をガードで保護。

--------------------------------------------------------------------

## v1.73-unified-safe (2026-01-22)
（完全統合・安全性強化・機種依存排除版）

### Added
- DFPlayer フェイルセーフ（8秒固定）
- A0/D6 AUTO 判定（固定型）
- Arduino視点の配線命名（ARD_RX_FROM_DFP=10 / ARD_TX_TO_DFP=11）
- STOP/RESUME（x / r）
- HELP（h）

### Changed
- “汎用プリセット（H）” を再設計（s0/t0/b3900）
- 周期IDを絶対時刻スケジューリングに
- A0/D6 前段処理を整理

### Fixed
- D10/D11 命名混乱、HTMLエスケープ残存、AUTO未固定を修正
- STOP中 LED 残点灯を修正

--------------------------------------------------------------------

## v1.72-final-EEPROM+F (2026-01-20)

### Added
- Factory Reset（F）
- EEPROM 永続化
- AUTO固定後に保存

### Changed
- x → r の動作仕様統一

### Fixed
- A0 初期化不足、HTMLエスケープ残存修正

--------------------------------------------------------------------

## v1.71-stable-final (2026-01-19)
### Added
- HELP、STOP、t0/t1
- q に LONG_TALK_MS 追加

### Fixed
- DFPlayer BUSY 戻り判定に 40ms 安定時間
- 未初期化の pinMode 等を修正

--------------------------------------------------------------------

## v1.71 (Integrated-MAX) — 2026-01-19
### Added
- b#### による MAX/LONG の統合設定
- 未使用側 LED 点滅

### Notes
- AUTO は 30 分窓

--------------------------------------------------------------------

## v1.69g (2026-01-15)
### Added
- H プリセット（s0/t0/b3900）

### Fixed
- 安定性改善

--------------------------------------------------------------------

## v1.69f (2026-01-12)
### Changed
- デフォルトを v1.67c 互換へ

--------------------------------------------------------------------

## v1.69e (2026-01-09)
### Added
- AUTO（D6/A0発生数比較）
- D13 LED 点滅通知

--------------------------------------------------------------------

## v1.69c (2026-01-09)
### Changed
- LED 優先順位見直し

--------------------------------------------------------------------

## v1.69b (2026-01-09)
### Added
- 抑止ステータスLED

### Changed
- BUSY_MAX_MS を 2500ms に拡張

--------------------------------------------------------------------

## v1.68 Series (2025-12-End)
- A0 ヒステリシス + 保持
- 長話/バースト抑止追加
- Δt ログ可視化

--------------------------------------------------------------------

## v1.67 Series (2025-12-Mid)
- 送信後抑止（3秒）
- D2 へ DFPlayer ミラー出力

--------------------------------------------------------------------

## v1.64 (2025-12-Early)
- PTT最低ONガード
- BUSYヒステリシス再設計

--------------------------------------------------------------------

## Pre-v1.64 / Prototype — 2025-08〜
- v1.50：初の安定版（D6 BUSY判定、PTT PRE/POST）
- D6 monitor
- CCVoice 初期プロトタイプ

--------------------------------------------------------------------

## 付録：ピンマップ（Arduino Nano / 最新 v1.73c 時点）

 Pin | 機能 | 備考
-----|------|------
 D2  | DFP BUSYミラー出力 | 再生中=HIGH（反転）
 D3  | テストSW | INPUT_PULLUP
 D4  | 受信LED(D6) | D6/AUTO時
 D5  | PTT出力 | HIGH=送信
 D6  | TM BUSY入力 | 極性切替可（g0/g1）
 D7  | DFPlayer BUSY入力 | LOW=再生中
 D10 | Arduino RX | ← DFPlayer TX
 D11 | Arduino TX | → DFPlayer RX
 D12 | A0 LED | A0/AUTO時
 D13 | 抑止/AUTO LED | 長会話・バースト・AUTO固定通知
 A0  | アナログ入力 | ヒステリシス＋保持適用

--------------------------------------------------------------------