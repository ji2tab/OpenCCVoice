# CHANGELOG.md - OpenCCVoice ID Guidance Controller

本プロジェクトは、Arduino Nano (ATmega328P, 5V) 上で動作する、DMR無線機の ID送出支援コントローラです。

記法: Keep a Changelog 準拠
日付: JST（日本標準時）

--------------------------------------------------------------------

## v1.73b — Unified/Safe + TM Busy Polarity Cmd (2026-01-22)

### Added
- g#### コマンドを追加（g0/g1）  
  - g0 = TM BUSY が **LOW=受信（アクティブLOW）**  
  - g1 = TM BUSY が **HIGH=受信（アクティブHIGH）**  
- TM BUSY 極性（g0/g1）を **EEPROM保存**  
  再起動後も極性設定を維持  
- 要約（q）に **TM_BUSY_POL=LOW/HIGH** を表示  
  接続無線機の BUSY 仕様がすぐに確認可能

### Changed
- readTmD6() が g0/g1 設定を完全反映  
- AUTOモード中の D6 統計処理も g0/g1 を反映するよう修正  
- 古いEEPROMを読み込んだ場合、tmBusyActiveHigh が不正値なら自動補正（HIGH=busy）

### Notes
- この変更により、BUSY 出力が  
  **「受信でLOW」タイプの無線機**  
  **「受信でHIGH」タイプの無線機**  
  のどちらにも配線変更なしで対応可能になった。

--------------------------------------------------------------------

## v1.73a — Unified/Safe + DFP Timeout Cmd (2026-01-22)

### Added
- d#### コマンドで DFPlayer フェイルセーフ（ms）を可変化。d0 で無効化。
- 要約 q に DFP_TIMEOUT(ms) を追加表示。

### Changed
- 既定の DFP_TIMEOUT_MS を 20000ms（20秒）に変更（長尺IDでも安定再生）。

### Notes
- フェイルセーフ無効時も、PLAYING内判定は評価スキップ（ガード実装）済み。

--------------------------------------------------------------------

## v1.73-unified-safe (2026-01-22)
（完全統合・安全性強化・機種依存排除版）

本版は、試験的要素や個別機材名称を全て撤廃し、どの環境でも使える完全汎用版として再構成した最新完成形。

### Added
- DFPlayer フェイルセーフ（8秒固定）
  BUSY が出ない／戻らない場合でも PTT の張り付きを 8 秒で強制停止。
- A0/D6 AUTO 判定（固定型）
  観測窓 w## 分間で D6 / A0 の発生数比較で自動固定（EEPROM保存）。
  固定時 D13 LED が 3 秒高速点滅。
- Arduino視点の配線命名へ完全統一
  ARD_RX_FROM_DFP=10（DFP TX） / ARD_TX_TO_DFP=11（DFP RX）
- STOP/RESUME（x / r）完全統合
- HELP（h）コマンド追加

### Changed
- 機種固有表現をすべて廃止 → 完全汎用化
- H プリセットを “汎用プリセット”（s0 / t0 / b3900）に再定義
- 周期IDを絶対時刻基準スケジューリングに統一
- A0 / D6 前段処理（ヒステリシス、統計）の整理

### Fixed
- D10/D11 の命名混乱、HTMLエスケープ残存、AUTO未固定の稀な不具合を修正
- STOP 中 LED が残点灯するケースを修正

--------------------------------------------------------------------

## v1.72-final-EEPROM+F (2026-01-20)

### Added
- Factory Reset（F）:
  初期値へ戻し EEPROMに即保存（再起動後も初期状態で起動）
- EEPROM 永続化:
  m, b, n, s, t, r, p, w, L/G/a を即保存
- AUTO 判定後、自動固定 & EEPROM保存

### Changed
- x（停止）→ r（再開）の仕様確立
- 汎用プリセット H（s0 / t0 / b4000）定義

### Fixed
- 初期化漏れ、未定義、HTMLエスケープ残存など修正

--------------------------------------------------------------------

## v1.71-stable-final (2026-01-19)

### Added
- h（ヘルプ）、x（STOP）、t0/t1
- q（要約）に LONG_TALK_MS 追加

### Fixed
- DFPlayer BUSY 戻り判定に 40ms の安定時間を追加
- pinMode 初期化漏れ、未定義など複数箇所修正

--------------------------------------------------------------------

## v1.71 (Integrated-MAX) — 2026-01-19

### Added
- b#### による BUSY_MAX_MS / LONG_TALK_MS の統合設定
- 未使用側 LED の点滅機能追加

### Notes
- AUTO は 30 分窓 + グレース

--------------------------------------------------------------------

## v1.69g (Preset & Stability) — 2026-01-15

### Added
- 汎用プリセット H（s0 / t0 / b3900）

### Fixed
- 複数の安定性・コンパイル問題を修正

--------------------------------------------------------------------

## v1.69f (Unified Architecture) — 2026-01-12

### Changed
- デフォルトを v1.67c 互換（D6固定・抑止なし）へ統一
- 必要機能はコマンドで ON する形式へ変更

--------------------------------------------------------------------

## v1.69e (AUTO Mode – Count Based) — 2026-01-09

### Added
- AUTO（D6/A0発生数比較方式）
- 決定時 D13 LED を 2Hz / 3秒点滅

--------------------------------------------------------------------

## v1.69c (Status LED Priority) — 2026-01-09

### Changed
- LED優先順位：  
  長会話 ＞ 送信後抑止 ＞ バースト ＞ OFF

--------------------------------------------------------------------

## v1.69b (Extended Limits) — 2026-01-09

### Added
- 抑止ステータス LED（D13）

### Changed
- BUSY_MAX_MS を 2500ms へ引き上げ

--------------------------------------------------------------------

## v1.68 Series (A0 Integration & Monitoring) — 2025-12-End

### Added
- A0 ヒステリシス（L/G）＋保持 a(ms)
- 長話/バーストの文脈抑止
- Δt ログ

--------------------------------------------------------------------

## v1.67 Series — 2025-12-Mid

### Added
- TX後抑止（3秒）
- DFPlayer BUSY ミラー D2 出力

--------------------------------------------------------------------

## v1.64 — 2025-12-Early

### Changed
- PTT最低ONガード
- BUSYヒステリシス

--------------------------------------------------------------------

## Pre-v1.64 / Prototype — 2025-08〜

### History
- 1.50：初の安定版（D6 BUSY判定、PTT PRE/POST）
- D6 monitor：テストツール
- CCVoice：初期プロトタイプ

--------------------------------------------------------------------

## 付録：ピンマップ（Arduino Nano / 最新 v1.73b 時点）

 Pin | 機能 | 備考
-----|------|------
 D2  | DFP BUSYミラー出力 | 再生中=HIGH（反転）
 D3  | テストSW | INPUT_PULLUP
 D4  | 受信LED(D6) | D6/AUTO時
 D5  | PTT出力 | HIGH=送信
 D6  | TM BUSY入力 | 極性切替可（g0/g1）
 D7  | DFPlayer BUSY入力 | LOW=再生中
 D10 | Arduino RX | ← DFPlayer TX
 D11 | Arduino TX | → DFPlayer RX
 D12 | A0 LED | A0/AUTO時
 D13 | 抑止/AUTO LED | 長会話・バースト・AUTO固定通知
 A0  | アナログ入力 | ヒステリシス＋保持適用

--------------------------------------------------------------------