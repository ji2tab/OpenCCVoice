# OpenCCVoice Guidance Controller
取扱説明書 / コマンドリファレンス
バージョン: v1.73b-Unified-Safe
最終更新日: 2026/01/26
対象ハード: Arduino Nano (ATmega328P / 5V)
通信設定: 115200 bps / 8N1 / 改行なし(またはLF)

--------------------------------------------------------------------

■ 概要
本機は DMR無線機のID送出を自動制御するコントローラです。
PCとUSB接続し、シリアルモニタから以下のコマンドで設定を変更できます。
設定は全て EEPROM に保存され、電源を切っても保持されます。

【本バージョンの特徴（v1.73b）】
- v1.69g のハードウェア配線（DFPlayer: RX=10 / TX=11）と完全互換。
- フェイルセーフ（DFPlayer応答なし時の強制停止時間）を可変化：
  d####（ms）/ d0=無効。既定は 20000ms（20秒）。
- TM BUSY（D6）の極性切替（g0/g1）を追加。
  → 無線機の BUSY が HIGH/LOW どちらでも対応可能。
- AUTO判定（m2）により、観測期間 w分後に D6/A0 を自動選択して固定・保存。
- 抑止、デバウンス、PTTガード、周期ID、A0ヒステリシスなど
  全ての安定化処理を統合。

--------------------------------------------------------------------

1. クイック・コマンド一覧

コマンド | パラメータ | 既定値 | 機能説明
--------|------------|--------|---------
m        | 0 / 1 / 2 | 0      | 動作モード（0:D6固定 / 1:A0固定 / 2:AUTO）
b        | 500〜     | 3900   | 最大受信時間（ms）※超えると長会話扱い
n        | 100〜     | 500    | 最小受信時間（ms）
i        | 0〜       | 200    | 直前アイドル最小時間（ms）
s        | 0 / 1     | 1      | 抑止機能 ON/OFF
t        | 0 / 1     | 1      | 送信後無視 ON/OFF（s1時のみ）
r        | 0〜       | 3000   | 送信後無視時間（ms）
p        | 0〜       | 30     | 周期ID送出間隔（分）※0で停止
w        | 1〜       | 30     | AUTO観測期間（分）
L        | 0〜1023   | 300    | A0感度（LOW閾値）
G        | 0〜1023   | 700    | A0感度（HIGH閾値）
a        | 0〜       | 800    | A0保持時間（ms）
d        | 0〜       | 20000  | DFPフェイルセーフ（ms）※0=無効
g        | 0 / 1     | 1      | TM BUSY極性（0:LOW=受信、1:HIGH=受信）
q        | なし       | -      | 現在設定値の一覧表示
H        | なし       | -      | 汎用プリセット（s0/t0/b3900）
x        | なし       | -      | システム停止（Safe Stop）
r        | なし       | -      | 停止状態からの復帰（x後のみ）
h        | なし       | -      | コマンド一覧（HELP）
0〜3     | なし       | -      | ログレベル（0:NONE〜3:DBG）
F        | なし       | -      | 工場出荷状態に戻す（EEPROM初期化）

--------------------------------------------------------------------

2. コマンド詳細解説

【m：モード設定】
m0 : D6（デジタルBUSY）使用［推奨］  
m1 : A0（アナログ音声レベル）使用  
m2 : AUTO判定（w分観測 → D6/A0 の優位側を固定し保存）  
※AUTO中は両方の入力に反応してIDが出る。

【b：最大受信時間】
受信継続が b#### を超えると「通話」と判定し ID を出さない。

【n / i：最小受信時間 / 直前アイドル】
n：BUSY継続が短すぎる場合はノイズ扱い  
i：直前アイドルが短い場合、短発判定を無効化（誤トリガ防止）

【s / t / r：抑止ガード】
s1：長会話（dur>=BUSY_MAX）で10s抑止  
　　バースト（10s窓で2回）で10s抑止  
t1：送信後 r#### ms 受信を無視  
r：送信後無視期間（誤認防止）

【p：周期ID】
p##（分）間隔。0で停止。  
絶対時刻（起動時間）基準で等間隔送信。

【w：AUTO観測期間】
w分観測 → D6/A0 の優位側で固定、EEPROM保存。  
固定時 D13 LED 高速点滅（約3秒）。

【A0判定（L/G/a）】
L：LOW閾値  
G：HIGH閾値  
a：保持時間  
A0のアナログBUSY判定を安定化する。

【d：DFPフェイルセーフ】
DFPlayer BUSY が戻らない場合の最大再生時間（ms）  
既定値＝20000ms（20秒）  
d0 = 無効化（PTT張り付き検出をスキップ）

【g：TM BUSY極性切替（v1.73b 新規）】
g0 = LOW=受信（アクティブLOWの無線機）  
g1 = HIGH=受信（アクティブHIGHの無線機）  
EEPROMに保存されるため、再起動後も保持。

【x / r：停止と再開】
x：全動作を停止  
r：停止中のみ復帰

【F：初期値に戻す】
m0 / b3900 / s1 / d20000 等へ戻して EEPROMを書き換える。

【h / 0〜3：ヘルプ・ログ】
h：HELP表示  
0〜3：ログレベル

--------------------------------------------------------------------

3. LED表示の意味

[D4] D6 LED  
  点灯 = D6 BUSY 受信中  
  AUTO中は D12 と交互点滅  
[D12] A0 LED  
  点灯 = A0 判定 動作中  
[D13] 抑止/AUTO LED  
  点灯 = 抑止中  
  点滅 = バースト窓動作中  
  高速点滅 = AUTO固定通知（約3秒）  
[D2] DFP BUSY ミラー  
  HIGH = 再生中（反転出力）  
  LOW  = 停止中

--------------------------------------------------------------------

4. 安全機能（フェイルセーフ）

DFPlayer が BUSY を戻さない場合、  
PTT張り付き防止として **設定値（d####）** 経過で強制OFF。

- 既定：d20000（20秒）
- 無効化：d0（PLAYING内判定をスキップ）

--------------------------------------------------------------------

5. トラブルシューティング

● IDが出ない  
- 停止中（x）では？ → r で復帰  
- b3900 を超える長会話では反応しない  
- D13 点灯中（抑止）では反応しない

● IDが止まらない  
- t1 / r#### を増やす  
- n#### / i#### を増やして誤検知低減

● 音声が途中で切れる  
- d#### を増やす（例：d20000）  
- `/mp3/0001.mp3` のSD構成確認  
- D7(BUSY)が途中で HIGH になっていないか確認

● BUSY判定が逆  
- 極性設定（g0/g1）を確認  
- D6 のプルアップ（INPUT_PULLUP）必須

--------------------------------------------------------------------

6. 配線メモ（v1.73b）

DFPlayer TX → D10（Arduino RX）  
DFPlayer RX ← D11（Arduino TX）  
DFPlayer BUSY（LOW=再生中）→ D7  
D7 ミラー（反転）→ D2  
TM BUSY → D6（g0/g1 で極性指定）  
PTT → D5（HIGH=送信）  
LED → D4（D6） / D12（A0） / D13（抑止/AUTO）  
テストSW → D3（INPUT_PULLUP）

--------------------------------------------------------------------