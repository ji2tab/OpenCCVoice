========================================================================
TM-8250 ID Guidance Controller
取扱説明書 / コマンドリファレンス
========================================================================
バージョン: 1.72-final-EEPROM+F (Factory Reset 対応)
最終更新日: 2026/01/20
対象ハード: Arduino Nano (ATmega328P / 5V)
通信設定  : 115200 bps / 8N1 / 改行なし(またはLF)
========================================================================

■ 概要
TM-8250 ID Guidance Controller は、TM-8250 系無線機において受信の
「短発（カーチャンク）」を検出し、DFPlayer Mini で音声IDを自動送出する
コントローラです。受信時間・抑止・周期ID・A0感度などはシリアルコマンドで
調整でき、設定は EEPROM に保存されます。

- MCU         : Arduino Nano（ATmega328P, 5V）
- 音声再生    : DFPlayer Mini（BUSYで再生状態監視）
- 受信検出    : D6（TM BUSY）または A0（アナログ検出）
- 自動選択    : AUTO（m2）で D6/A0 の優位を一定時間測定して固定
- 設定永続化  : EEPROM に保存（電源OFFでも保持）

注意: A0 と D6 は同時接続不可（必ず片側のみ配線）。

------------------------------------------------------------------------
1. クイック・コマンド一覧
------------------------------------------------------------------------
[コマンド]  [パラメータ]    [既定値]   [機能説明]

 m          0 / 1 / 2         0       動作モード切替
                                      (0:D6固定 / 1:A0固定 / 2:AUTO)
 b          500〜           1500      最大受信時間 (ms)
                                      ※これを超えると長会話とみなす
 n          100〜            500      最小受信時間 (ms)
                                      ※これ未満はノイズ扱い
 s          0 / 1             1       抑止機能 ON/OFF
 t          0 / 1             1       送信後無視 ON/OFF (s1時のみ有効)
 r          0〜             3000      送信終了後の受信無視時間 (ms)
 p          0〜              30       周期ID送出間隔 (分) ※0で停止
 w          1〜              30       AUTOモードの判定期間 (分)
 L          0〜1023          300      A0検知 開始しきい値
 G          0〜1023          700      A0検知 終了しきい値
 a          0〜              800      A0検知 保持時間 (ms)

 q          なし              -       現在の設定値を一覧表示
 H          なし              -       H1プリセット（s0/t0/b4000）
 x          なし              -       システム停止 (PTT/LED/判定 OFF)
 r          なし              -       停止状態から復帰
 F          なし              -       ★Factory Reset（全設定を初期値へ）
 0/1/2/3    ログレベル設定（NONE/ERR/INFO/DEBUG）

------------------------------------------------------------------------
2. コマンド詳細解説
------------------------------------------------------------------------

【m：モード設定】
  m0 : デジタルBUSY(D6)を使用するモード
  m1 : A0アナログ音声検知を使用するモード
  m2 : AUTO判定開始（w分後にD6/A0のどちらかへ自動固定＋EEPROM保存）

【b：最大受信時間（ms）】
  この時間を超える受信は「通話」とみなし、IDは送出しません。
  b#### で BUSY_MAX_MS と LONG_TALK_MS が同時に変わります。

【s / t / r：抑止ガード】
  s1 : 長話／バースト後のIDを抑止します。
  t1 : 送信直後 r(ms) の受信を無視します。
  r  : 送信後の受信無視時間。

【H：H1プリセット】
  以下を一括適用します（現場復旧用）:
    ・s0（抑止OFF）
    ・t0（送信後抑止OFF）
    ・b4000（上限3.9秒）

【x / r：停止・再開】
  x : すべての動作（PTT/LED/判定）を停止  
  r : 停止状態を解除して再開

【F：Factory Reset（初期値へ）】
  F : 全設定を工場出荷時（初期設定）に戻します。
      applyDefaults() 実行 → EEPROM に即保存 → 再起動後も初期設定で開始。

------------------------------------------------------------------------
3. LED表示の意味
------------------------------------------------------------------------
 D4  (D6 LED) : D6受信中は点灯。未使用系統時は点滅。
 D12 (A0 LED) : A0検知中は点灯。未使用系統時は点滅。
 D13 (抑止LED):
     点灯     = 抑止中（長会話 / 送信後 / バースト）
     点滅     = バースト検知
     高速点滅 = AUTO確定時（3秒間）

------------------------------------------------------------------------
4. トラブルシューティング
------------------------------------------------------------------------
・IDが出ない
  → 「x」で停止していませんか？「r」で再開できます。
  → D13が点灯している場合：抑止中です。
  → b の値が短すぎる可能性があります（例：b3000 に増加）。

・IDが出続ける
  → t1 にして r の値を増やしてください（例：r5000）。
  → n の値を増やし、短いノイズを無視させてください。

・設定を初期値に戻したい
  → F を実行してください（全項目初期化・EEPROMも更新）。

・AUTOが確定しない
  → w を短く（例：w1）し、D6/A0 のどちらかを多く発生させてください。

・DFPlayerが鳴らない
  → SoftwareSerial の RX/TX 順と D7 BUSY 配線を確認してください。

------------------------------------------------------------------------
5. 仕様上の制限
------------------------------------------------------------------------
- A0 と D6 の同時接続は禁止（誤検知の原因）。
- DFPlayer BUSY には個体差あり。必要に応じタイムアウトを追加。
- IDLE_MIN_MS は現行ロジックでは未使用（将来拡張用）。

------------------------------------------------------------------------
6. 保守・更新
------------------------------------------------------------------------
- 変更履歴は CHANGELOG.md を参照。
- 推奨ログレベルは 2（INFO）。
- EEPROMの先頭領域をバックアップしておくと復元が容易です。

========================================================================
【仕様書（技術者向け）】
========================================================================

1. 基本情報
- 名称     : TM-8250 ID Guidance Controller
- バージョン: 1.72-final-EEPROM+F
- MCU      : Arduino Nano（ATmega328P, 5V）
- 依存     : SoftwareSerial.h、EEPROM.h
- DFPlayer : BUSY監視（D7=LOW 再生中）、9600bps制御

2. 機能仕様（Functional）
(1) 短発受信の自動ID送出  
  dur が BUSY_MIN_MS ≤ dur < BUSY_MAX_MS のとき ID（トラック1）送出  
  DFPlayer BUSY HIGH を 40ms 安定で再生完了判定  
  PTT PRE/POST = 各 1000ms

(2) 抑止（長話・バースト・送信後）  
  dur ≥ BUSY_MAX_MS → LONG_SUP_MS=10s  
  10秒間に2回以上の短発 → BURST_SUP_MS=10s  
  t1 時、送信後 TX_SUP_MS(ms) の受信無視

(3) AUTO（m2）  
  AUTO_WINDOW(分)中の D6エッジ/A0イベントで優位側へ自動固定  
  固定後 autoLocked=true、EEPROM保存  
  切替時 D13 を3秒高速点滅、直後1秒の受信抑止

(4) 周期ID  
  PERIOD_MSごとにトラック2/3を交互送出（IDLE時のみ）

(5) EEPROM 永続化  
  m/n/b/p/r/L/G/a/w/s/t の変更で即保存  
  起動時にロード。magicエラー時は applyDefaults()

(6) LED可視化  
  使用側LED=実反応、未使用側=点滅  
  抑止LED: 抑止/バースト/AUTO確定などを可視化

3. 非機能仕様（Non-Functional）
- 応答性: D6デバウンス5ms  
- 安定性: DFPlayer BUSY 40ms確認、PTTガード  
- 可搬性: Arduino IDE 1.8.x/2.x  
- 保守性: printSummary()、ログレベル

4. インタフェース仕様
- D2  : DFP BUSYミラー出力  
- D3  : テストSW INPUT_PULLUP  
- D4  : D6系LED  
- D5  : PTT出力  
- D6  : TM BUSY 入力  
- D7  : DFPlayer BUSY 入力  
- D10 : DFPlayer TX  
- D11 : DFPlayer RX  
- D12 : A0系LED  
- D13 : 抑止LED  
- A0  : アナログ入力（0..1023）

5. 既定値
BUSY_INPUT_SOURCE=D6  
BUSY_MIN_MS=500  
BUSY_MAX_MS=1500（＝LONG_TALK_MS）  
PERIOD_MS=30min  
TX_SUP_MS=3000  
SUPPRESSORS_ENABLED=true  
TX_AFTER_SUPPRESS_ENABLED=true  
A0_LOW_TH=300 / A0_HIGH_TH=700 / A0_HOLD=800  
AUTO_WINDOW=30min

6. コマンド仕様（完全）
m0/m1/m2  
n####  
b####  
i####(未使用)  
s0/s1  
t0/t1  
r####  
p##  
w##  
L### / G### / a####  
q  
H  
x / r  
F（Factory Reset）  
0/1/2/3

7. 振る舞い仕様
dur < MIN     → 無効  
MIN ≤ dur < MAX → 短発  
dur ≥ MAX     → 長話抑止  
PTTステート：IDLE → ON_WAIT → PLAYING → OFF_WAIT → IDLE

8. 制約
デバウンス 5ms  
EEPROM 書込みは変更時のみ  
SRAM制約内（2KB）

9. 試験
m0 にて 600ms→ID、1600ms→抑止  
AUTO: m2→w1→[AUTO-FIXED]  
t1/r3000：送信後3s無視

10. リスク
DFPlayer BUSY 個体差  
外部回路のプルアップ不足  
A0/D6 同時配線は禁止

11. 変更履歴
詳細は CHANGELOG.md を参照

========================================================================