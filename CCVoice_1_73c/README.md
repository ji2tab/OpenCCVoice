# OpenCCVoice Guidance Controller
取扱説明書 / コマンドリファレンス
バージョン: v1.73c-Unified-Safe
最終更新日: 2026/01/26
対象ハード: Arduino Nano (ATmega328P / 5V)
通信設定: 115200 bps / 8N1 / 改行なし(またはLF)

--------------------------------------------------------------------

■ 概要
本機は DMR無線機のID送出を自動制御するコントローラです。
PCとUSB接続し、シリアルモニタから各種コマンドで設定を変更できます。

全ての設定は EEPROM に自動保存され、電源断でも保持されます。
v1.73c から EEPROM にバージョン管理機能を搭載し、スケッチ更新時の設定破損を防ぐ仕様になりました。

--------------------------------------------------------------------

■ 本バージョン（v1.73c）の特徴

[EEPROM バージョン管理を導入（config.ver）]
- 起動時に EEPROM のレイアウト版を判定
- 古いバージョンを自動補完/移行（マイグレーション）
- 不正値・未知バージョン → 自動初期化
- q に EEPROM_VER=3 と表示

[v1.73b の強化ポイントも継承]
- TM BUSY（D6）の極性切替：
  g0 = LOW=busy, g1 = HIGH=busy
- フェイルセーフ（DFPlayer応答なし）を可変化：
  d20000（20秒）／ d0 で無効化
- AUTO 判定（m2）：D6/A0の優位側を自動固定
- 抑止（長話/短発バースト/送信後）、PTTガード、BUSYデバウンス、周期ID を統合

--------------------------------------------------------------------

1. クイック・コマンド一覧

コマンド | パラメータ | 既定値 | 説明
---------------------------------------------------------------
m        | 0/1/2      | 0      | D6固定 / A0固定 / AUTO判定
b        | 500〜      | 3900   | 最大受信長 (ms)
n        | 100〜      | 500    | 最小受信長 (ms)
i        | 0〜        | 200    | 直前アイドル時間 (ms)
s        | 0/1        | 1      | 抑止 ON/OFF
t        | 0/1        | 1      | 送信後無視 ON/OFF（s1時）
r        | 0〜        | 3000   | 送信後無視時間 (ms)
p        | 0〜        | 30     | 周期ID（分）※0=停止
w        | 1〜        | 30     | AUTO観測時間（分）
L        | 0〜1023    | 300    | A0閾値LOW
G        | 0〜1023    | 700    | A0閾値HIGH
a        | 0〜        | 800    | A0保持時間(ms)
d        | 0〜        | 20000  | DFPフェイルセーフ(ms) ※0=無効
g        | 0/1        | 1      | TM BUSY極性 (LOW/HIGH=busy)
q        | -          | -      | 設定一覧（EEPROM_VER含む）
H        | -          | -      | 汎用プリセット (s0/t0/b3900)
x        | -          | -      | Safe Stop（全機能停止）
r        | -          | -      | 停止状態から復帰
h        | -          | -      | コマンド一覧
0〜3     | -          | -      | ログレベル
F        | -          | -      | Factory Reset（EEPROM初期化）

--------------------------------------------------------------------

2. コマンド詳細解説

[m：モード設定]
m0 … D6（デジタルBUSY）を使用
m1 … A0（アナログレベル）を使用
m2 … AUTO 判定（w分観測後 D6/A0 いずれかに自動固定）
※AUTO観測中は D6/A0どちらでも IDが出る

[b：最大受信長]
b3900（3.9秒）が既定。超過は「通話」と判断し ID を出さない
dur>=MAX の後は 10秒間 ID送信禁止（長話抑止）

[n / i：最小受信 / 直前アイドル]
n####：dur < n はノイズ扱い
i####：直前アイドル < i は短発判定を無効化（誤認防止）

[s / t / r：抑止ガード]
s1：抑止 ON（長話/バーストで10秒抑止）
t1：送信後 r#### ms 無視
r####：送信後無視時間（誤認防止）

[p：周期ID]
p##（分）でトラック2/3を交互に送出。0で停止
絶対時間（起動時刻）基準で等間隔

[w：AUTO観測期間]
w分観測 → D6/A0統計 → 優位側へ固定し EEPROM保存
固定時 D13 LED 高速点滅（約3秒）

[A0検知（L/G/a）]
A0 のアナログ BUSY 判定（LOW/HIGH閾値と保持時間で安定化）

[d：DFPフェイルセーフ]
DFPlayer BUSY が戻らない場合の最大再生時間
既定：d20000（20秒）／ d0：無効（PLAYING内の判定スキップ）

[g：TM BUSY極性（v1.73b）]
g0 = LOW=受信（アクティブLOW）
g1 = HIGH=受信（アクティブHIGH）
EEPROM に保存され再起動後も保持

[x / r：停止と再開]
x：全機能停止（PTT/判定/LED）
r：停止中のみ復帰

[F：初期値へ]
m0 / b3900 / s1 / d20000 / g1 等へ戻して EEPROM 保存

[h / 0〜3：ヘルプ・ログ]
h：HELP 表示
0〜3：ログレベル（NONE/ERR/INF/DBG）

--------------------------------------------------------------------

3. LED表示

[D4] … D6 BUSY受信時 点灯（AUTO中はD12と交互点滅）
[D12] … A0検知時 点灯（AUTO中はD4と交互）
[D13] … 抑止/短発窓/Auto固定通知（高速点滅は固定時 約3秒）
[D2] … DFPlayer BUSYミラー（反転：再生中=HIGH / 停止中=LOW）

--------------------------------------------------------------------

4. フェイルセーフ（DFPlayer BUSY異常）

DFPlayer BUSY が戻らない場合、
設定値（d####）経過後に PTT を強制OFF。

- 既定：d20000
- d0：無効化（PLAYING内のチェック除外）

--------------------------------------------------------------------

5. トラブルシューティング

● IDが出ない
- 停止中（x）→ r
- 長話（b3900超）→ 抑止中
- D13 点灯中は抑止

● IDが止まらない
- t1 / r#### を増やす
- n#### / i#### を上げて誤検知低減

● 音声が途中で切れる
- d#### を長めに（例：d20000）
- SDカード `/mp3/0001.mp3` の配置確認
- D7(BUSY)が途中で HIGH になっていないか

● BUSY判定が逆
- g0/g1 の極性設定を確認
- D6 は INPUT_PULLUP 必須

--------------------------------------------------------------------

6. 配線メモ（v1.73c）

DFPlayer TX → D10（Arduino RX）
DFPlayer RX ← D11（Arduino TX）
DFPlayer BUSY（LOW=再生中）→ D7
D7 ミラー（反転）→ D2
TM BUSY → D6（g0/g1で極性設定）
PTT → D5（HIGH=送信）
LED → D4（D6） / D12（A0） / D13（抑止/AUTO）
テストSW → D3（INPUT_PULLUP）

--------------------------------------------------------------------

7. v1.73c 追加仕様（重要）

[EEPROM バージョン管理（CONFIG_VERSION=3）]
- スケッチ更新時、古い EEPROM を読み込んでも設定崩壊しない
- config.ver ≠ 3 の場合：補完または初期化（マイグレーション実行）
- 旧設定（b/n/s/t/p/w/L/G/a 等）はできる限り引き継ぐ

[要約（q）に EEPROM_VER 表示]
例：
[CFG] EEPROM_VER=3 SRC=D6 MIN=500 ... TM_BUSY_POL=HIGH=busy

--------------------------------------------------------------------