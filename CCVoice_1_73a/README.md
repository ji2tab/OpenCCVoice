
# OpenCCVoice Guidance Controller  
**取扱説明書 / コマンドリファレンス**  
バージョン: **v1.73a-Unified-Safe**  
最終更新日: **2026/01/22**  
対象ハード: **Arduino Nano (ATmega328P / 5V)**  
通信設定: **115200 bps / 8N1 / 改行なし(またはLF)**

---

## ■ 概要
本機は **DMR無線機のID送出** を自動制御するコントローラです。  
PCとUSB接続し、**シリアルモニタ**から以下のコマンドで設定を変更できます。  
変更した設定は即座に **内部メモリ(EEPROM)** に保存され、電源を切っても保持されます。

### 本バージョンの特徴
- **v1.69g のハードウェア配線（DFPlayer: RX=10 / TX=11）** のまま動作する互換版です。
- 既定の **最大受信許容時間は 3.9秒（b3900）** です（汎用プリセットに基づく）。
- **安全機能（フェイルセーフ）** として、音声モジュールが応答しない場合に **既定 20秒** で強制的に送信を停止します（**`d####` で可変、`d0` で無効化**）。
- **AUTO判定（m2）** により、観測期間（`w` 分）後に **D6/A0 のいずれかへ自動固定**し、EEPROMに保存します（以後、再起動後も固定が維持）。

---

## 1. クイック・コマンド一覧

| コマンド | パラメータ | 既定値 | 機能説明 |
|---|---:|---:|---|
| `m` | `0 / 1 / 2` | `0` | 動作モード切替（`0:D6固定 / 1:A0固定 / 2:AUTO`） |
| `b` | `500〜` | `3900` | **最大受信時間 (ms)** ※これを超えると長会話とみなす |
| `n` | `100〜` | `500` | **最小受信時間 (ms)** ※これ未満はノイズとして無視 |
| `i` | `0〜` | `200` | **直前アイドル最小時間 (ms)** |
| `s` | `0 / 1` | `1` | 抑止機能 ON/OFF（長会話・連打対策） |
| `t` | `0 / 1` | `1` | 送信後無視 ON/OFF（`s1` 時のみ有効） |
| `r` | `0〜` | `3000` | 送信終了後の受信無視時間 (ms) |
| `p` | `0〜` | `30` | 周期ID送出間隔 (分) ※`0`で停止 |
| `w` | `1〜` | `30` | AUTOモードの判定期間 (分) |
| `L` | `0〜1023` | `300` | A0アナログ検知 感度下限 |
| `G` | `0〜1023` | `700` | A0アナログ検知 感度上限 |
| `a` | `0〜` | `800` | A0アナログ検知 保持時間 (ms) |
| `d` | `0〜` | `20000` | **DFPタイムアウト (ms)**。`0`=無効（フェイルセーフ無効化） |
| `q` | なし | - | 現在の設定値を一覧表示 |
| `H` | なし | - | 汎用プリセット適用（`s0 / t0 / b3900`） |
| `x` | なし | - | システム停止（保守用・PTT禁止） |
| `r` | なし | - | 「x」で停止した処理を再開する |
| `h` | なし | - | コマンド一覧（ヘルプ）を表示 |
| `0〜3` | なし | - | ログレベル切替（`0:NONE / 1:ERR / 2:INF / 3:DBG`） |
| `F` | なし | - | すべての設定を初期値へ戻す（`EEPROM` 初期化 + `applyDefaults` 実行） |

---

## 2. コマンド詳細解説

### 【m：モード設定】
- `m0` : デジタル信号（D6）を使用します。**[推奨]**
- `m1` : アナログ音声（A0）を使用します。
- `m2` : **自動判定（AUTO）** を開始します。設定した **`w`(分)** の間データを測定し、**優位な方（D6/A0）に自動で固定・保存**します。  
  ※AUTO観測中は、**D6/A0 いずれの信号でも ID が出ます**。

### 【b：最大受信時間（カーチャンク許容時間）】
相手の送信がこの時間（ミリ秒）を超えた場合、「通話」とみなして ID 送出を行いません。  
また、**長会話直後は ID 送出を一定時間禁止**します（長文抑止）。  
例：`b3900` → **3.9秒** までの送信には反応し、それ以上は無視。

### 【n / i：最小受信時間・直前アイドル】
- `n` : 受信継続がこの値未満の場合は**ノイズ等として無視**。
- `i` : 受信直前のアイドルがこの値未満の場合、**短発判定を無効化**（誤トリガ低減）。

### 【s / t / r：抑止ガード】
IDの乱発を防ぐ機能です。通常は **`s1` `t1`** で使用してください。
- `s1` : 長会話の後や、短い連打（バースト）があった時に **ID を止める**。  
   （短発は **10秒窓/2回** しきい、長会話は `b` の超過を検出）
- `t1` : 自分が ID を出した直後の **`r`(ミリ秒)** 間、受信を無視。回り込み・誤認対策。
- `r`  : 送信後無視の**継続時間 (ms)**。例：`r5000`

### 【p：周期ID（002/003 交互）】
`p##`（分）で周期IDをスケジュールします。`0`で停止。  
起動時刻からの**絶対時刻基準で等間隔**に送出します。

### 【w：AUTO判定の観測期間（分）】
観測期間満了で D6/A0 の発生数を比較し、**優位側へ固定・保存**します。  
**固定時は D13 LED が約3秒間点滅**して通知します。

### 【L / G / a：A0アナログ検知パラメータ】
- `L` : LOW閾値、`G` : HIGH閾値、`a` : 検出保持(ms)  
  ヒステリシス＋保持で**アナログ音声のBUSYを安定判定**します。

### 【d：DFPタイムアウト（フェイルセーフ）】
- `d####` : **DFPlayer応答なし時の強制停止タイムアウト（ms）** を設定します。  
  例：`d20000` → **20秒**（既定） / `d0` → **無効化**（フェイルセーフなし）。  
  ※`d0` の場合でも、内部で**タイムアウト判定は評価スキップ**されます（即時終了はしません）。

### 【q：要約表示】
現在の主要パラメータ（モード、各閾値、周期、抑止状態、**DFP_TIMEOUT(ms)** 等）を一覧表示。

### 【H：汎用プリセット】
よくある構成向けの簡易プリセット：
- 抑止機能(`s`) = **OFF**
- 送信後無視(`t`) = **OFF**
- 最大受信時間(`b`) = **3900 (3.9秒)**

### 【x / r：停止と再開】
- `x` : 一切の動作（PTT/LED/判定）を停止（**Safe Stop**）。
- `r` : 停止状態を解除し、通常動作へ復帰。  
   ※この `r` は**停止中のみ有効**（数値パラメータの `r####` とは用途が異なります）。

### 【F：初期値へリセット】
- `F` : すべての設定を**工場出荷時（初期設定）**に戻します。  
  - モードは **D6固定 (`m0`)**  
  - 最大受信時間は **3900ms (`b3900`)**  
  - **EEPROM を初期化**  
  設定がおかしくなった場合はまずこのコマンドを実行してください。

### 【h / 0〜3：ヘルプ・ログレベル】
- `h` : コマンド一覧を表示。  
- `0〜3` : ログレベル切替（`0:NONE` / `1:ERR` / `2:INF` / `3:DBG`）。

---

## 3. LED表示の意味

- **[D4] (D6 LED)** : 点灯 = D6信号を受信中  
- **[D12] (A0 LED)** : 点灯 = A0音声を検知中  
  - ※AUTO判定中は、D4/D12 が**交互に点滅**  
  - ※未使用側（`m0` 時の A0 など）は**待機中ゆっくり点滅**

- **[D13] (抑止/AUTO LED)**  
  - **点灯**   = 抑止中（長会話直後 / 短発連打中 / 送信後抑止中）  
  - **点滅**   = バースト検知ウィンドウ動作中（短時間連打を検知）  
  - **高速点滅** = AUTOモードで設定が確定した合図（約3秒間）

- **[D2] (DFP BUSYミラー)**  
  - **再生中 = HIGH**（反転出力） / **停止中 = LOW**

---

## 4. 安全機能（フェイルセーフ）について
DFPlayer（音声モジュール）の故障やSDカードの接触不良により「再生中信号」が返ってこない場合でも、送信(PTT)がオンのまま固定されるのを防止します。

- **強制タイムアウト（既定 20秒）**  
  PTT開始から **設定値（既定 20000ms）** 経過しても再生が完了しない場合、**強制的に PTT を OFF** にします。  
  無変調電波の垂れ流し事故を防止します。  
  ※`d####` で可変。**`d0` で無効化**できます（無効時はタイムアウト判定を評価しません）。

---

## 5. トラブルシューティング

- **IDが出ない**  
  → `x` コマンドで停止していませんか？ `r` で再開できます。  
  → 相手の送信が長すぎませんか？ `b` の値を確認（例: **3.9秒超は無視**）。  
  → D13 が点灯していませんか？**抑止機能**が働いています。

- **IDが出続ける / 止まらない**  
  → `t1` にして `r` の時間を延ばしてください（例: `r5000`）。  
  → ノイズの可能性：`n` や `i` の値を上げてください。

- **送信(PTT)が一瞬入るが、すぐ切れる（音声が出ない）**  
  → SDカードのデータ構成を確認（`/mp3/0001.mp3` 等、モジュール仕様準拠）。  
  → 配線（**D10=Arduino RX / D11=Arduino TX**）が正しいか確認。  
  → フェイルセーフの設定値を確認（`q` に **DFP_TIMEOUT(ms)** が表示）。長尺IDの場合は `d20000` などへ調整。

- **設定がおかしくなった / 元に戻したい**  
  → `F` で初期設定に戻せます（EEPROM も初期化）。

---

## 6. 配線メモ（抜粋 / v1.69g 準拠）

- **DFPlayer TX → Arduino D10（Arduino側 RX）**  
- **DFPlayer RX ← Arduino D11（Arduino側 TX）**  
- **DFPlayer BUSY（多くの個体で LOW=再生中）→ D7**  
- **D7 BUSYミラー（反転出力）→ D2（再生中=HIGH / 停止中=LOW）**  
- **TM BUSY → D6**（極性は回路に依存。必要に応じてコード側で切替）  
- **PTT → D5（HIGH=送信）**  
- **LED → D4(D6受信表示) / D12(A0表示) / D13(抑止/AUTO通知)**  
- **テストSW → D3（INPUT_PULLUP）**

---
``
